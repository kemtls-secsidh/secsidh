.intel_syntax noprefix

.section .rodata

.set pbits,2047
.set pbytes,256
.set plimbs,32


.global secsidh_internal_2047m1l226_p
secsidh_internal_2047m1l226_p:
.quad 0xFFFFFFFFFFFFFFFF,0xCB336E65DD9AB972,0x31DA9904076E6A70,0x9F825D7BEA428F54 
.quad 0x80B1D7895DEABE60,0xD3B3CDE44A99EBD8,0x2C433638FE69F531,0x46C02600030671E2 
.quad 0x3EB36EBF24EB264F,0x5872FD3292CF3725,0x25261B882C99A891,0x5AA0C7A8E51C618F 
.quad 0xDFE30228DC090A5E,0x1235FFF9C3496720,0x556D82DFB25A19E0,0xAF0D91A49AD1FCF6 
.quad 0x5CFE8BDDCAAF7214,0x67D90F84820F3740,0x85DD61C29F9EA3FA,0x1B493E97510173BA 
.quad 0x57963F8A2EF281C0,0x215B3CA607652A95,0xBE13D52039838268,0xC1B8B0AC479FC5EB 
.quad 0xAACDDF254A1CEFF1,0x5D89B511362EE752,0x5C935F8B2C251C39,0x3336CCFC4DD81041 
.quad 0xFE4AEA834B8F332,0x8AA77CDCE5CCA52,0x2DD1AFC034E7A378,0x4B5882EA64EA57E7 



.global secsidh_internal_2047m1l226_inv_min_p_mod_r
secsidh_internal_2047m1l226_inv_min_p_mod_r:
.quad 0x1,0xCB336E65DD9AB973,0xAF643763A21D419,0x9F2BDE02384F089B 
.quad 0xEEEE4E67E761E071,0xE14F6E448846FC16,0x7C33F1CB8995D537,0x9C5E5A0E41FBBB2B 
.quad 0x4018415AA62AB0F7,0x570A5C7C482D3FA4,0x290CBC45D2ED6704,0x6935DDB9DA0BF373 
.quad 0xA9C3A7DCE054C2E7,0x1A92280608691985,0x786A946F6A893A4E,0x817444232C2B50DA 
.quad 0x51BC998B9190158,0xED0A80A509441339,0x70CCCC137B5E8F1D,0x425869F7AD1DEB2C 
.quad 0xE27606BD4F848CE,0xF78A71E7CFC37870,0x347E7689108AA61E,0xD89DFF0D518DFEFF 
.quad 0x7223F57C599BD0D8,0xA84199D7B55177A2,0xBADC4BDDEB193D87,0x3C4583C1A5C1CD7 
.quad 0x8ACB116EB508F9DF,0x23F88493636893F,0x47A93C3A24EFEA29,0x5420403EEAB4C43E 



.global secsidh_internal_2047m1l226_fp_0
secsidh_internal_2047m1l226_fp_0:
.zero pbytes


.global secsidh_internal_2047m1l226_fp_1
secsidh_internal_2047m1l226_fp_1:
.quad 0x3,0x9E65B4CE672FD3A7,0x6A7034F3E9B4C0AD,0x2178E78C41385203 
.quad 0x7DEA7963E63FC4DE,0x84E4965320323C76,0x7B365D5504C2206A,0x2BBF8DFFF6ECAA59 
.quad 0x43E5B3C2913E8D12,0xF6A7086847925A90,0x908DAD677A33064B,0xF01DA90550AADB52 
.quad 0x6056F9856BE4E0E4,0xC95E0012B623CA9D,0xFFB77760E8F1B25F,0xF2D74B122F8A091C 
.quad 0xE9045C669FF1A9C1,0xC874D17279D25A3E,0x6E67DAB821241410,0xAE24443A0CFBA4D0 
.quad 0xF93D416173287ABF,0x9BEE4A0DE9D0803F,0xC5C4809F537578C7,0xBAD5EDFB2920AE3C 
.quad 0xFF96629021A9302A,0xE762E0CC5D734A07,0xEA45E15E7B90AB53,0x665B990B1677CF3B 
.quad 0xD051F40761D52669,0xE600989694E9A109,0x768AF0BF61491597,0x1DF67740D140F84A 

.global secsidh_internal_2047m1l226_fp_2
secsidh_internal_2047m1l226_fp_2:
.quad 0x6,0x3CCB699CCE5FA74E,0xD4E069E7D369815B,0x42F1CF188270A406 
.quad 0xFBD4F2C7CC7F89BC,0x9C92CA6406478EC,0xF66CBAAA098440D5,0x577F1BFFEDD954B2 
.quad 0x87CB6785227D1A24,0xED4E10D08F24B520,0x211B5ACEF4660C97,0xE03B520AA155B6A5 
.quad 0xC0ADF30AD7C9C1C9,0x92BC00256C47953A,0xFF6EEEC1D1E364BF,0xE5AE96245F141239 
.quad 0xD208B8CD3FE35383,0x90E9A2E4F3A4B47D,0xDCCFB57042482821,0x5C48887419F749A0 
.quad 0xF27A82C2E650F57F,0x37DC941BD3A1007F,0x8B89013EA6EAF18F,0x75ABDBF652415C79 
.quad 0xFF2CC52043526055,0xCEC5C198BAE6940F,0xD48BC2BCF72156A7,0xCCB732162CEF9E77 
.quad 0xA0A3E80EC3AA4CD2,0xCC01312D29D34213,0xED15E17EC2922B2F,0x3BECEE81A281F094 

.global secsidh_internal_2047m1l226_r_squared_mod_p 
secsidh_internal_2047m1l226_r_squared_mod_p :
.quad 0x7F4DD8E5DF23BB8,0x5C776D52280157ED,0x649F1DDABA652A4C,0x5F82754E976E1C51 
.quad 0x216A66554955B423,0x837F16EBDA6112EC,0x449BE2BE3F1308CA,0xD417CF96FBD398E 
.quad 0xF40CA379B3CFDD87,0xE572142C0A18BEF2,0x174A98FEF7CBBD6D,0x92147FED3A21520A 
.quad 0xC2FEF4524FB5A582,0x7EA04A000CF05B29,0xEE7604D0586AEE7,0x360C6B9E4402ACBE 
.quad 0x2412C3AB8629CC28,0x11843E0F489CD4DA,0x965E567F2D69ADA1,0xC35FDB6E0A1CE3AC 
.quad 0xDFCE999B5BE1D15D,0xADFC765457B8334C,0x178A9115F96B28ED,0x7C25482F10317EEF 
.quad 0x87B1090C7F92BA82,0xF6E929FCF67F4BB3,0xDAB73BE93D26BAA6,0xA520E31962981EFB 
.quad 0xD1EBB498F914FB73,0x71AAAC9068F25B31,0x18F8EE6ACA512273,0x2EA634B399D69CF7 

.global secsidh_internal_2047m1l226_p_minus_2
secsidh_internal_2047m1l226_p_minus_2:
.quad 0xFFFFFFFFFFFFFFFD,0xCB336E65DD9AB972,0x31DA9904076E6A70,0x9F825D7BEA428F54 
.quad 0x80B1D7895DEABE60,0xD3B3CDE44A99EBD8,0x2C433638FE69F531,0x46C02600030671E2 
.quad 0x3EB36EBF24EB264F,0x5872FD3292CF3725,0x25261B882C99A891,0x5AA0C7A8E51C618F 
.quad 0xDFE30228DC090A5E,0x1235FFF9C3496720,0x556D82DFB25A19E0,0xAF0D91A49AD1FCF6 
.quad 0x5CFE8BDDCAAF7214,0x67D90F84820F3740,0x85DD61C29F9EA3FA,0x1B493E97510173BA 
.quad 0x57963F8A2EF281C0,0x215B3CA607652A95,0xBE13D52039838268,0xC1B8B0AC479FC5EB 
.quad 0xAACDDF254A1CEFF1,0x5D89B511362EE752,0x5C935F8B2C251C39,0x3336CCFC4DD81041 
.quad 0xFE4AEA834B8F332,0x8AA77CDCE5CCA52,0x2DD1AFC034E7A378,0x4B5882EA64EA57E7 



.global secsidh_internal_2047m1l226_p_minus_1_halves
secsidh_internal_2047m1l226_p_minus_1_halves:
.quad 0x7FFFFFFFFFFFFFFF,0x6599B732EECD5CB9,0x18ED4C8203B73538,0x4FC12EBDF52147AA 
.quad 0x4058EBC4AEF55F30,0xE9D9E6F2254CF5EC,0x16219B1C7F34FA98,0xA3601300018338F1 
.quad 0x9F59B75F92759327,0xAC397E9949679B92,0x92930DC4164CD448,0x2D5063D4728E30C7 
.quad 0x6FF181146E04852F,0x91AFFFCE1A4B390,0x2AB6C16FD92D0CF0,0x5786C8D24D68FE7B 
.quad 0x2E7F45EEE557B90A,0x33EC87C241079BA0,0x42EEB0E14FCF51FD,0xDA49F4BA880B9DD 
.quad 0xABCB1FC5177940E0,0x10AD9E5303B2954A,0xDF09EA901CC1C134,0xE0DC585623CFE2F5 
.quad 0x5566EF92A50E77F8,0xAEC4DA889B1773A9,0xAE49AFC596128E1C,0x199B667E26EC0820 
.quad 0x7F257541A5C7999,0x4553BE6E72E6529,0x96E8D7E01A73D1BC,0x25AC417532752BF3 



.global secsidh_internal_2047m1l226_p_minus_3_quarters
secsidh_internal_2047m1l226_p_minus_3_quarters:
.quad 0xBFFFFFFFFFFFFFFF,0x32CCDB997766AE5C,0xC76A64101DB9A9C,0x27E0975EFA90A3D5 
.quad 0x202C75E2577AAF98,0x74ECF37912A67AF6,0x8B10CD8E3F9A7D4C,0xD1B0098000C19C78 
.quad 0x4FACDBAFC93AC993,0x561CBF4CA4B3CDC9,0xC94986E20B266A24,0x96A831EA39471863 
.quad 0x37F8C08A37024297,0x48D7FFE70D259C8,0x955B60B7EC968678,0x2BC3646926B47F3D 
.quad 0x173FA2F772ABDC85,0x99F643E12083CDD0,0xA1775870A7E7A8FE,0x6D24FA5D4405CEE 
.quad 0x55E58FE28BBCA070,0x856CF2981D94AA5,0xEF84F5480E60E09A,0x706E2C2B11E7F17A 
.quad 0xAAB377C952873BFC,0x57626D444D8BB9D4,0x5724D7E2CB09470E,0x8CCDB33F13760410 
.quad 0x83F92BAA0D2E3CCC,0x22A9DF373973294,0xCB746BF00D39E8DE,0x12D620BA993A95F9 



.section .text

.p2align 4,,15

.global secsidh_internal_2047m1l226_fp_copy
secsidh_internal_2047m1l226_fp_copy:
    cld
    mov rcx, plimbs
    rep movsq
    ret

.global secsidh_internal_2047m1l226_fp_cswap
secsidh_internal_2047m1l226_fp_cswap:
    movzx rax, dl
    neg rax
    .set k, 0
    .rept plimbs
        mov rcx, [rdi + 8*k]
        mov rdx, [rsi + 8*k]
        mov r8, rcx
        xor r8, rdx
        and r8, rax

        xor rcx, r8
        xor rdx, r8

        mov [rdi + 8*k], rcx
        mov [rsi + 8*k], rdx

        .set k, k+1
    .endr
    ret

.global secsidh_internal_2047m1l226_fp_cmov
secsidh_internal_2047m1l226_fp_cmov:
    movzx rax, dl
    neg rax
    .set k, 0
    .rept plimbs
        mov rcx, [rdi + 8*k]
        mov rdx, [rsi + 8*k]
        xor rdx, rcx
        and rdx, rax
        xor rcx, rdx
        mov [rdi + 8*k], rcx
        .set k, k+1
    .endr
    ret

.reduce_once:
    push rbp
    push r12
    push r13
    mov rbp, rdi
    mov r12, secsidh_internal_2047m1l226_p@GOTPCREL[rip]

    mov rdi, [rbp +  0]
    sub rdi, [r12]
    mov rsi, [rbp +  8]
    sbb rsi, [r12 + 8]
    mov rdx, [rbp +  16]
    sbb rdx, [r12 + 16]
    mov rcx, [rbp +  24]
    sbb rcx, [r12 + 24]
    mov r8, [rbp +  32]
    sbb r8, [r12 + 32]
    mov r9, [rbp +  40]
    sbb r9, [r12 + 40]
    mov r10, [rbp +  48]
    sbb r10, [r12 + 48]
    mov r11, [rbp +  56]
    sbb r11, [r12 + 56]

    mov rdi, [rbp +  64]
    sbb rdi, [r12 + 64]
    mov rsi, [rbp +  72]
    sbb rsi, [r12 + 72]
    mov rdx, [rbp +  80]
    sbb rdx, [r12 + 80]
    mov rcx, [rbp +  88]
    sbb rcx, [r12 + 88]
    mov r8, [rbp +  96]
    sbb r8, [r12 + 96]
    mov r9, [rbp +  104]
    sbb r9, [r12 + 104]
    mov r10, [rbp +  112]
    sbb r10, [r12 + 112]
    mov r11, [rbp +  120]
    sbb r11, [r12 + 120]

    mov rdi, [rbp +  128]
    sbb rdi, [r12 + 128]
    mov rsi, [rbp +  136]
    sbb rsi, [r12 + 136]
    mov rdx, [rbp +  144]
    sbb rdx, [r12 + 144]
    mov rcx, [rbp +  152]
    sbb rcx, [r12 + 152]
    mov r8, [rbp +  160]
    sbb r8, [r12 + 160]
    mov r9, [rbp +  168]
    sbb r9, [r12 + 168]
    mov r10, [rbp +  176]
    sbb r10, [r12 + 176]
    mov r11, [rbp +  184]
    sbb r11, [r12 + 184]

    mov rdi, [rbp +  192]
    sbb rdi, [r12 + 192]
    mov rsi, [rbp +  200]
    sbb rsi, [r12 + 200]
    mov rdx, [rbp +  208]
    sbb rdx, [r12 + 208]
    mov rcx, [rbp +  216]
    sbb rcx, [r12 + 216]
    mov r8, [rbp +  224]
    sbb r8, [r12 + 224]
    mov r9, [rbp +  232]
    sbb r9, [r12 + 232]
    mov r10, [rbp +  240]
    sbb r10, [r12 + 240]
    mov r11, [rbp +  248]
    sbb r11, [r12 + 248]


    setnc al
    movzx rax, al
    neg rax

.macro cswap2, r, m
    xor \r, \m
    and \r, rax
    xor \m, \r
.endm


    cswap2 rdi, [rbp +  192]
    cswap2 rsi, [rbp +  200]
    cswap2 rdx, [rbp +  208]
    cswap2 rcx, [rbp +  216]
    cswap2 r8, [rbp +  224]
    cswap2 r9, [rbp +  232]
    cswap2 r10, [rbp +  240]
    cswap2 r11, [rbp +  248]

    mov rdi, [rbp +  0]
    sub rdi, [r12]
    mov rsi, [rbp +  8]
    sbb rsi, [r12 + 8]
    mov rdx, [rbp +  16]
    sbb rdx, [r12 + 16]
    mov rcx, [rbp +  24]
    sbb rcx, [r12 + 24]
    mov r8, [rbp +  32]
    sbb r8, [r12 + 32]
    mov r9, [rbp +  40]
    sbb r9, [r12 + 40]
    mov r10, [rbp +  48]
    sbb r10, [r12 + 48]
    mov r11, [rbp +  56]
    sbb r11, [r12 + 56]

    mov rdi, [rbp +  64]
    sbb rdi, [r12 + 64]
    mov rsi, [rbp +  72]
    sbb rsi, [r12 + 72]
    mov rdx, [rbp +  80]
    sbb rdx, [r12 + 80]
    mov rcx, [rbp +  88]
    sbb rcx, [r12 + 88]
    mov r8, [rbp +  96]
    sbb r8, [r12 + 96]
    mov r9, [rbp +  104]
    sbb r9, [r12 + 104]
    mov r10, [rbp +  112]
    sbb r10, [r12 + 112]
    mov r11, [rbp +  120]
    sbb r11, [r12 + 120]

    mov rdi, [rbp +  128]
    sbb rdi, [r12 + 128]
    mov rsi, [rbp +  136]
    sbb rsi, [r12 + 136]
    mov rdx, [rbp +  144]
    sbb rdx, [r12 + 144]
    mov rcx, [rbp +  152]
    sbb rcx, [r12 + 152]
    mov r8, [rbp +  160]
    sbb r8, [r12 + 160]
    mov r9, [rbp +  168]
    sbb r9, [r12 + 168]
    mov r10, [rbp +  176]
    sbb r10, [r12 + 176]
    mov r11, [rbp +  184]
    sbb r11, [r12 + 184]

    cswap2 rdi, [rbp +  128]
    cswap2 rsi, [rbp +  136]
    cswap2 rdx, [rbp +  144]
    cswap2 rcx, [rbp +  152]
    cswap2 r8, [rbp +  160]
    cswap2 r9, [rbp +  168]
    cswap2 r10, [rbp +  176]
    cswap2 r11, [rbp +  184]

    mov rdi, [rbp +  0]
    sub rdi, [r12]
    mov rsi, [rbp +  8]
    sbb rsi, [r12 + 8]
    mov rdx, [rbp +  16]
    sbb rdx, [r12 + 16]
    mov rcx, [rbp +  24]
    sbb rcx, [r12 + 24]
    mov r8, [rbp +  32]
    sbb r8, [r12 + 32]
    mov r9, [rbp +  40]
    sbb r9, [r12 + 40]
    mov r10, [rbp +  48]
    sbb r10, [r12 + 48]
    mov r11, [rbp +  56]
    sbb r11, [r12 + 56]

    mov rdi, [rbp +  64]
    sbb rdi, [r12 + 64]
    mov rsi, [rbp +  72]
    sbb rsi, [r12 + 72]
    mov rdx, [rbp +  80]
    sbb rdx, [r12 + 80]
    mov rcx, [rbp +  88]
    sbb rcx, [r12 + 88]
    mov r8, [rbp +  96]
    sbb r8, [r12 + 96]
    mov r9, [rbp +  104]
    sbb r9, [r12 + 104]
    mov r10, [rbp +  112]
    sbb r10, [r12 + 112]
    mov r11, [rbp +  120]
    sbb r11, [r12 + 120]

    cswap2 rdi, [rbp +  64]
    cswap2 rsi, [rbp +  72]
    cswap2 rdx, [rbp +  80]
    cswap2 rcx, [rbp +  88]
    cswap2 r8, [rbp +  96]
    cswap2 r9, [rbp +  104]
    cswap2 r10, [rbp +  112]
    cswap2 r11, [rbp +  120]

    mov rdi, [rbp +  0]
    sub rdi, [r12]
    mov rsi, [rbp +  8]
    sbb rsi, [r12 + 8]
    mov rdx, [rbp +  16]
    sbb rdx, [r12 + 16]
    mov rcx, [rbp +  24]
    sbb rcx, [r12 + 24]
    mov r8, [rbp +  32]
    sbb r8, [r12 + 32]
    mov r9, [rbp +  40]
    sbb r9, [r12 + 40]
    mov r10, [rbp +  48]
    sbb r10, [r12 + 48]
    mov r11, [rbp +  56]
    sbb r11, [r12 + 56]

    cswap2 rdi, [rbp +  0]
    cswap2 rsi, [rbp +  8]
    cswap2 rdx, [rbp +  16]
    cswap2 rcx, [rbp +  24]
    cswap2 r8, [rbp +  32]
    cswap2 r9, [rbp +  40]
    cswap2 r10, [rbp +  48]
    cswap2 r11, [rbp +  56]
    pop r13
    pop r12
    pop rbp
    ret


.global secsidh_internal_2047m1l226_fp_add2
secsidh_internal_2047m1l226_fp_add2:
  mov rdx, rdi

.global secsidh_internal_2047m1l226_fp_add
secsidh_internal_2047m1l226_fp_add:
  push rdi
  call secsidh_internal_2047m1l226_uintbig_add
  pop rdi

  jmp .reduce_once

.global secsidh_internal_2047m1l226_fp_sub2
secsidh_internal_2047m1l226_fp_sub2:
  mov rdx, rdi
  xchg rsi, rdx

.global secsidh_internal_2047m1l226_fp_sub
secsidh_internal_2047m1l226_fp_sub:
  push rdi
  call secsidh_internal_2047m1l226_uintbig_sub
  pop rdi


  neg rax

  sub rsp, pbytes

  mov r8, secsidh_internal_2047m1l226_p@GOTPCREL[rip]
  mov rcx, [r8]
  and rcx, rax
  mov [rsp + 0],rcx
  .set k, 1
  .rept plimbs-1
      mov rcx, [r8 + 8*k]
      and rcx, rax
      mov [rsp + 8*k], rcx
      .set k, k+1
  .endr

  mov rcx, [rsp +  0]
  add rcx, [rdi +  0]
  mov [rdi +  0], rcx
  .set k, 1
  .rept plimbs-1
      mov rcx, [rsp + 8*k]
      adc rcx, [rdi + 8*k]
      mov [rdi + 8*k], rcx
      .set k, k+1
  .endr

  add rsp, pbytes
  ret


/* Montgomery arithmetic */

.global secsidh_internal_2047m1l226_fp_enc
secsidh_internal_2047m1l226_fp_enc:
    mov r8, secsidh_internal_2047m1l226_r_squared_mod_p@GOTPCREL[rip]
    lea rdx, [r8]
    jmp secsidh_internal_2047m1l226_fp_mul

.global secsidh_internal_2047m1l226_fp_dec
secsidh_internal_2047m1l226_fp_dec:
    mov r8, secsidh_internal_2047m1l226_uintbig_1@GOTPCREL[rip]
    lea rdx, [r8]
    jmp secsidh_internal_2047m1l226_fp_mul



.global secsidh_internal_2047m1l226_fp_mul2
secsidh_internal_2047m1l226_fp_mul2:
  mov rdx, rdi
.global secsidh_internal_2047m1l226_fp_mul
secsidh_internal_2047m1l226_fp_mul:
  push rbp
  push rbx
  push r14

  sub rsp, 272
  mov [rsp+ 264],rdi
  mov rdi,rsi
  mov rsi,rdx


  xor rax,rax
  mov [rsp+0],rax
  mov [rsp+8],rax
  mov [rsp+16],rax
  mov [rsp+24],rax
  mov [rsp+32],rax
  mov [rsp+40],rax
  mov [rsp+48],rax
  mov [rsp+56],rax
  mov [rsp+64],rax
  mov [rsp+72],rax
  mov [rsp+80],rax
  mov [rsp+88],rax
  mov [rsp+96],rax
  mov [rsp+104],rax
  mov [rsp+112],rax
  mov [rsp+120],rax
  mov [rsp+128],rax
  mov [rsp+136],rax
  mov [rsp+144],rax
  mov [rsp+152],rax
  mov [rsp+160],rax
  mov [rsp+168],rax
  mov [rsp+176],rax
  mov [rsp+184],rax
  mov [rsp+192],rax
  mov [rsp+200],rax
  mov [rsp+208],rax
  mov [rsp+216],rax
  mov [rsp+224],rax
  mov [rsp+232],rax
  mov [rsp+240],rax
  mov [rsp+248],rax
  mov [rsp+256],rax


.macro MULSTEP, k, I0,I1,I2,I3,I4,I5,I6,I7,I8,I9,I10,I11,I12,I13,I14,I15,I16,I17,I18,I19,I20,I21,I22,I23,I24,I25,I26,I27,I28,I29,I30,I31,I32

    mov r11,[rsp+\I0]
    mov rdx, [rsi +  0]
    mulx rcx, rdx, [rdi + 8*\k]
    add rdx, r11
    mov rax, secsidh_internal_2047m1l226_inv_min_p_mod_r@GOTPCREL[rip]
    mulx rcx, rdx, [rax]

    xor rax, rax /* clear flags */


    mov r14, secsidh_internal_2047m1l226_p@GOTPCREL[rip]
    mulx rbx, rax, [r14]
    adox r11, rax
    mov [rsp+\I0], r11

    mov r11,[rsp+\I1]
    mulx rcx, rax, [r14 + 8]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I1],r11

    mov r11,[rsp+\I2]
    mulx rbx, rax, [r14 + 16]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I2],r11

    mov r11,[rsp+\I3]
    mulx rcx, rax, [r14 + 24]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I3],r11

    mov r11,[rsp+\I4]
    mulx rbx, rax, [r14 + 32]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I4],r11

    mov r11,[rsp+\I5]
    mulx rcx, rax, [r14 + 40]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I5],r11

    mov r11,[rsp+\I6]
    mulx rbx, rax, [r14 + 48]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I6],r11

    mov r11,[rsp+\I7]
    mulx rcx, rax, [r14 + 56]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I7],r11

    mov r11,[rsp+\I8]
    mulx rbx, rax, [r14 + 64]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I8],r11

    mov r11,[rsp+\I9]
    mulx rcx, rax, [r14 + 72]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I9],r11

    mov r11,[rsp+\I10]
    mulx rbx, rax, [r14 + 80]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I10],r11

    mov r11,[rsp+\I11]
    mulx rcx, rax, [r14 + 88]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I11],r11

    mov r11,[rsp+\I12]
    mulx rbx, rax, [r14 + 96]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I12],r11

    mov r11,[rsp+\I13]
    mulx rcx, rax, [r14 + 104]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I13],r11

    mov r11,[rsp+\I14]
    mulx rbx, rax, [r14 + 112]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I14],r11

    mov r11,[rsp+\I15]
    mulx rcx, rax, [r14 + 120]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I15],r11

    mov r11,[rsp+\I16]
    mulx rbx, rax, [r14 + 128]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I16],r11

    mov r11,[rsp+\I17]
    mulx rcx, rax, [r14 + 136]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I17],r11

    mov r11,[rsp+\I18]
    mulx rbx, rax, [r14 + 144]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I18],r11

    mov r11,[rsp+\I19]
    mulx rcx, rax, [r14 + 152]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I19],r11

    mov r11,[rsp+\I20]
    mulx rbx, rax, [r14 + 160]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I20],r11

    mov r11,[rsp+\I21]
    mulx rcx, rax, [r14 + 168]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I21],r11

    mov r11,[rsp+\I22]
    mulx rbx, rax, [r14 + 176]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I22],r11

    mov r11,[rsp+\I23]
    mulx rcx, rax, [r14 + 184]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I23],r11

    mov r11,[rsp+\I24]
    mulx rbx, rax, [r14 + 192]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I24],r11

    mov r11,[rsp+\I25]
    mulx rcx, rax, [r14 + 200]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I25],r11

    mov r11,[rsp+\I26]
    mulx rbx, rax, [r14 + 208]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I26],r11

    mov r11,[rsp+\I27]
    mulx rcx, rax, [r14 + 216]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I27],r11

    mov r11,[rsp+\I28]
    mulx rbx, rax, [r14 + 224]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I28],r11

    mov r11,[rsp+\I29]
    mulx rcx, rax, [r14 + 232]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I29],r11

    mov r11,[rsp+\I30]
    mulx rbx, rax, [r14 + 240]
    adcx r11, rcx
   adox r11, rax
    mov [rsp+\I30],r11

    mov r11,[rsp+\I31]
    mulx rcx, rax, [r14 + 248]
    adcx r11, rbx
   adox r11, rax
    mov [rsp+\I31],r11


    mov r11,[rsp+\I32]
    mov rax, 0
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I32],r11

    mov rdx, [rdi + 8*\k]

    xor rax, rax /* clear flags */

    mov r11,[rsp+\I0]
    mulx rbx, rax, [rsi +  0]
    adox r11, rax
    mov [rsp+\I0],r11

    mov r11,[rsp+\I1]
    mulx rcx, rax, [rsi +  8]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I1],r11

    mov r11,[rsp+\I2]
    mulx rbx, rax, [rsi +  16]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I2],r11

    mov r11,[rsp+\I3]
    mulx rcx, rax, [rsi +  24]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I3],r11

    mov r11,[rsp+\I4]
    mulx rbx, rax, [rsi +  32]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I4],r11

    mov r11,[rsp+\I5]
    mulx rcx, rax, [rsi +  40]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I5],r11

    mov r11,[rsp+\I6]
    mulx rbx, rax, [rsi +  48]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I6],r11

    mov r11,[rsp+\I7]
    mulx rcx, rax, [rsi +  56]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I7],r11

    mov r11,[rsp+\I8]
    mulx rbx, rax, [rsi +  64]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I8],r11

    mov r11,[rsp+\I9]
    mulx rcx, rax, [rsi +  72]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I9],r11

    mov r11,[rsp+\I10]
    mulx rbx, rax, [rsi +  80]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I10],r11

    mov r11,[rsp+\I11]
    mulx rcx, rax, [rsi +  88]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I11],r11

    mov r11,[rsp+\I12]
    mulx rbx, rax, [rsi +  96]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I12],r11

    mov r11,[rsp+\I13]
    mulx rcx, rax, [rsi +  104]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I13],r11

    mov r11,[rsp+\I14]
    mulx rbx, rax, [rsi +  112]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I14],r11

    mov r11,[rsp+\I15]
    mulx rcx, rax, [rsi +  120]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I15],r11

    mov r11,[rsp+\I16]
    mulx rbx, rax, [rsi +  128]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I16],r11

    mov r11,[rsp+\I17]
    mulx rcx, rax, [rsi +  136]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I17],r11

    mov r11,[rsp+\I18]
    mulx rbx, rax, [rsi +  144]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I18],r11

    mov r11,[rsp+\I19]
    mulx rcx, rax, [rsi +  152]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I19],r11

    mov r11,[rsp+\I20]
    mulx rbx, rax, [rsi +  160]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I20],r11

    mov r11,[rsp+\I21]
    mulx rcx, rax, [rsi +  168]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I21],r11

    mov r11,[rsp+\I22]
    mulx rbx, rax, [rsi +  176]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I22],r11

    mov r11,[rsp+\I23]
    mulx rcx, rax, [rsi +  184]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I23],r11

    mov r11,[rsp+\I24]
    mulx rbx, rax, [rsi +  192]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I24],r11

    mov r11,[rsp+\I25]
    mulx rcx, rax, [rsi +  200]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I25],r11

    mov r11,[rsp+\I26]
    mulx rbx, rax, [rsi +  208]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I26],r11

    mov r11,[rsp+\I27]
    mulx rcx, rax, [rsi +  216]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I27],r11

    mov r11,[rsp+\I28]
    mulx rbx, rax, [rsi +  224]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I28],r11

    mov r11,[rsp+\I29]
    mulx rcx, rax, [rsi +  232]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I29],r11

    mov r11,[rsp+\I30]
    mulx rbx, rax, [rsi +  240]
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I30],r11

    mov r11,[rsp+\I31]
    mulx rcx, rax, [rsi +  248]
    adcx r11, rbx
    adox r11, rax
    mov [rsp+\I31],r11

    mov r11,[rsp+\I32]
    mov rax, 0
    adcx r11, rcx
    adox r11, rax
    mov [rsp+\I32],r11

.endm

MULSTEP 0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0
MULSTEP 1,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8
MULSTEP 2,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16
MULSTEP 3,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24
MULSTEP 4,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32
MULSTEP 5,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40
MULSTEP 6,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48
MULSTEP 7,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56
MULSTEP 8,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64
MULSTEP 9,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72
MULSTEP 10,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80
MULSTEP 11,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88
MULSTEP 12,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96
MULSTEP 13,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104
MULSTEP 14,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112
MULSTEP 15,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120
MULSTEP 16,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128
MULSTEP 17,144,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136
MULSTEP 18,152,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144
MULSTEP 19,160,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152
MULSTEP 20,168,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160
MULSTEP 21,176,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168
MULSTEP 22,184,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176
MULSTEP 23,192,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184
MULSTEP 24,200,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192
MULSTEP 25,208,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200
MULSTEP 26,216,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208
MULSTEP 27,224,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216
MULSTEP 28,232,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224
MULSTEP 29,240,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232
MULSTEP 30,248,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240
MULSTEP 31,256,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248


    mov rdi,[rsp+264]

    mov r11,[rsp+0]
    mov [rdi+0],r11
    mov r11,[rsp+8]
    mov [rdi+8],r11
    mov r11,[rsp+16]
    mov [rdi+16],r11
    mov r11,[rsp+24]
    mov [rdi+24],r11
    mov r11,[rsp+32]
    mov [rdi+32],r11
    mov r11,[rsp+40]
    mov [rdi+40],r11
    mov r11,[rsp+48]
    mov [rdi+48],r11
    mov r11,[rsp+56]
    mov [rdi+56],r11
    mov r11,[rsp+64]
    mov [rdi+64],r11
    mov r11,[rsp+72]
    mov [rdi+72],r11
    mov r11,[rsp+80]
    mov [rdi+80],r11
    mov r11,[rsp+88]
    mov [rdi+88],r11
    mov r11,[rsp+96]
    mov [rdi+96],r11
    mov r11,[rsp+104]
    mov [rdi+104],r11
    mov r11,[rsp+112]
    mov [rdi+112],r11
    mov r11,[rsp+120]
    mov [rdi+120],r11
    mov r11,[rsp+128]
    mov [rdi+128],r11
    mov r11,[rsp+136]
    mov [rdi+136],r11
    mov r11,[rsp+144]
    mov [rdi+144],r11
    mov r11,[rsp+152]
    mov [rdi+152],r11
    mov r11,[rsp+160]
    mov [rdi+160],r11
    mov r11,[rsp+168]
    mov [rdi+168],r11
    mov r11,[rsp+176]
    mov [rdi+176],r11
    mov r11,[rsp+184]
    mov [rdi+184],r11
    mov r11,[rsp+192]
    mov [rdi+192],r11
    mov r11,[rsp+200]
    mov [rdi+200],r11
    mov r11,[rsp+208]
    mov [rdi+208],r11
    mov r11,[rsp+216]
    mov [rdi+216],r11
    mov r11,[rsp+224]
    mov [rdi+224],r11
    mov r11,[rsp+232]
    mov [rdi+232],r11
    mov r11,[rsp+240]
    mov [rdi+240],r11
    mov r11,[rsp+248]
    mov [rdi+248],r11
    add rsp,272

    pop r14
    pop rbx
    pop rbp

    jmp .reduce_once



.global secsidh_internal_2047m1l226_fp_sq1
secsidh_internal_2047m1l226_fp_sq1:
    mov rsi, rdi
.global secsidh_internal_2047m1l226_fp_sqr
secsidh_internal_2047m1l226_fp_sqr:
    mov rdx, rsi

    jmp secsidh_internal_2047m1l226_fp_mul

.global secsidh_internal_2047m1l226_fp_random
secsidh_internal_2047m1l226_fp_random:

    push rdi
    mov rsi, pbytes
    call randombytes
    pop rdi
    mov rax, 1
    shl rax, (pbits % 64)
    dec rax
    and [rdi + pbytes-8], rax
    mov r8, secsidh_internal_2047m1l226_p@GOTPCREL[rip]
    .set k, plimbs-1
    .rept plimbs
        mov rax, [r8 + 8*k]
        cmp [rdi + 8*k], rax
        jge secsidh_internal_2047m1l226_fp_random
        jl 0f
        .set k, k-1
    .endr
    0:
    ret
